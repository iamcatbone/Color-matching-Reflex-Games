<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smash the 💩 Reflex Game - Desktop Music Game</title>
    <meta name="description" content="Fast-paced rhythm reflex game with arrow keys! Clear blocks, trigger special events, and smash the poop counter in penalty mode. 10 unique power-ups await!">
    <meta property="og:title" content="Smash the 💩 Reflex Game">
    <meta property="og:description" content="Fast-paced rhythm reflex game with arrow keys! Clear blocks, trigger special events, and smash the poop counter in penalty mode.">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Smash the 💩 Reflex Game">
    <meta name="twitter:description" content="Fast-paced rhythm reflex game with arrow keys! Clear blocks, trigger special events, and smash the poop counter in penalty mode.">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .game-container {
            max-width: 800px;
            width: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .pause-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .pause-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .score, .inputs-count {
            font-size: 1.2em;
            font-weight: bold;
            flex: 1;
        }

        .score-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .timer-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .timer {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 8px;
        }

        .timer.warning {
            color: #ff4757;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .timer-bar-container {
            width: 200px;
            height: 12px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.4);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1;
            opacity: 0.7;
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, rgba(78, 205, 196, 0.8), rgba(69, 183, 209, 0.8), rgba(255, 215, 0, 0.8));
            border-radius: 4px;
            transition: width 0.1s linear;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .timer-bar.warning {
            background: linear-gradient(90deg, rgba(255, 71, 87, 0.8), rgba(255, 107, 107, 0.8), rgba(255, 165, 2, 0.8));
            animation: barPulse 0.5s infinite;
        }

        .queue-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .queue-rows {
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-width: 600px;
            margin: 0 auto;
        }

        .queue-rows.four-columns {
            max-width: 800px;
        }

        .queue-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            height: 50px;
        }

        .queue-slot {
            flex: 1;
            max-width: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 1.5em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .queue-slot.empty {
            background: transparent;
        }

        .queue-slot.filled {
            border: 2px solid transparent;
        }

        .queue-slot.current {
            transform: scale(1.05);
            border: 3px solid white !important;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
            animation: glow 1s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
            50% { box-shadow: 0 0 25px rgba(255, 255, 255, 0.8); }
        }

        .column-headers {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .column-headers.four-columns {
            max-width: 800px;
        }

        .column-header {
            flex: 1;
            max-width: 150px;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .column-header.star { background: rgba(255, 107, 107, 0.3); }
        .column-header.triangle { background: rgba(78, 205, 196, 0.3); }
        .column-header.square { background: rgba(69, 183, 209, 0.3); }

        .queue-item {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            border-radius: 8px;
            font-size: 1.5em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .star { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); }
        .triangle { background: linear-gradient(135deg, #4ecdc4, #7fdbda); }
        .square { background: linear-gradient(135deg, #45b7d1, #6cc5e0); }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .key-hint {
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1em;
            min-width: 80px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .key-hint.star { background: rgba(255, 107, 107, 0.3); }
        .key-hint.triangle { background: rgba(78, 205, 196, 0.3); }
        .key-hint.square { background: rgba(69, 183, 209, 0.3); }

        .key-hint.pressed {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.4);
        }

        .penalty-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
        }

        .penalty-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .penalty-title {
            font-size: 3em;
            font-weight: bold;
            color: #ff4757;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        .penalty-emoji {
            font-size: 8em;
            position: relative;
            opacity: 0.75;
        }

        .penalty-counter {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.6em;
            font-weight: bold;
            color: #FFFF00;
            z-index: 1;
        }

        .penalty-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1.2em;
            height: 1.2em;
            border: 0.05em solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            z-index: 0;
        }

        .penalty-instruction {
            font-size: 1.2em;
            color: white;
            text-align: center;
            max-width: 400px;
        }

        .penalty-resume {
            font-size: 1.2em;
            color: #ffd700;
            text-align: center;
            max-width: 400px;
            font-weight: bold;
        }

        @keyframes barPulse {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(255, 71, 87, 0.7);
                opacity: 1;
            }
            50% { 
                box-shadow: 0 0 20px rgba(255, 71, 87, 1);
                opacity: 0.8;
            }
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .game-over-content {
            background: rgba(20, 20, 50, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid #ffd700;
        }

        .game-over h2 {
            color: #ff4757;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .final-score {
            font-size: 1.5em;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .restart-btn {
            background: linear-gradient(135deg, #45b7d1, #6cc5e0);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .restart-btn:hover {
            transform: scale(1.05);
        }

        .start-screen {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            margin-top: 50px;
        }

        .start-btn {
            background: linear-gradient(135deg, #4ecdc4, #7fdbda);
            border: none;
            padding: 20px 40px;
            border-radius: 15px;
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .start-btn:hover {
            transform: scale(1.05);
        }

        .instructions {
            text-align: left;
            margin: 20px 0;
            line-height: 1.6;
        }

        .countdown {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .countdown-number {
            font-size: 20em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
            animation: countdownPulse 1s ease-in-out;
            text-align: center;
            width: 100%;
            max-width: 600px;
        }

        @keyframes countdownPulse {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .event-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .event-content {
            background: rgba(20, 20, 50, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid #ffd700;
            max-width: 500px;
        }

        .event-content h2 {
            color: #ffd700;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .event-description {
            margin: 0; 
            text-align: left;
        }

        .event-ok-btn {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            color: #000;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .event-ok-btn:hover {
            transform: scale(1.05);
        }

        .event-space-hint {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 15px;
            font-style: italic;
        }

        .pause-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1800;
        }

        .pause-content {
            background: rgba(20, 20, 50, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid #ffd700;
            max-width: 400px;
        }

        .pause-content h2 {
            color: #ffd700;
            font-size: 2.5em;
            margin-bottom: 30px;
        }

        .pause-resume-btn {
            background: linear-gradient(135deg, #4ecdc4, #7fdbda);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px;
        }

        .pause-resume-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div id="startScreen" class="start-screen">
            <h1>💩 Smash the 💩 Reflex Game</h1>
            <div class="instructions">
                <h3>How to Play:</h3>
                <p>• Match symbols with arrow keys: <strong>←</strong> for ⬅️, <strong>↓</strong> for ⬇️, <strong>→</strong> for ➡️</p>
                <p>• You start with 10 seconds on the timer</p>
                <p>• Timer counts down continuously</p>
                <p>• +0.3s added for each correct input</p>
                <p>• <strong>Special events trigger every 600 points!</strong></p>
                <p>• <strong>Penalty System:</strong> Wrong inputs trigger penalty mode where you must hit ←, ↓, or → repeatedly to clear a countdown before resuming gameplay</p>
                <p>• Game ends after 2 consecutive wrong inputs or time runs out</p>
            </div>
            <button class="start-btn" onclick="startGame()" id="startBtn">Start Game</button>
        </div>

        <div id="gameScreen" style="display: none;">
            <div class="header">
                <div class="score-section">
                    <div class="score">Score: <span id="score">0</span></div>
                </div>
                <div class="timer-section">
                    <div class="timer" id="timer">10.0s</div>
                    <div class="timer-bar-container">
                        <div class="timer-bar" id="timerBar"></div>
                    </div>
                </div>
                <div class="inputs-count">Inputs: <span id="inputsCount">0</span></div>
                <button class="pause-btn" onclick="pauseGame()" id="pauseBtn">⏸️</button>
            </div>

            <div class="controls">
                <div class="key-hint star" id="keyArrowLeft">← - ⬅️</div>
                <div class="key-hint triangle" id="keyArrowDown">↓ - ⬇️</div>
                <div class="key-hint square" id="keyArrowRight">→ - ➡️</div>
            </div>

            <div class="queue-container">
                <div class="queue-rows">
                    <div id="queueRows"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="penalty-overlay" id="penaltyOverlay">
        <div class="penalty-content">
            <div class="penalty-title">PENALTY!</div>
            <div class="penalty-emoji">
                💩
                <div class="penalty-circle"></div>
                <div class="penalty-counter" id="penaltyCounter">5</div>
            </div>
            <div class="penalty-instruction" id="penaltyInstruction">
                Wrong input! Smash the poop to continue!<br>
                Hit ←, ↓ or → to beat the 💩 counter to 0
            </div>
        </div>
    </div>

    <div class="event-popup" id="eventPopup">
        <div class="event-content">
            <h2>🎊 Special Event! 🎊</h2>
            <div style="color: white !important; font-weight: normal !important; font-size: 1em !important; margin-bottom: 20px; text-align: center;">
                🎉 <strong>2s is added to the timer!!</strong> 🎉<br>
                <em>The timer is paused until you hit "OK"</em>
            </div>
            <div style="background: rgba(255, 215, 0, 0.15); border-radius: 10px; padding: 20px; margin: 15px 0;">
                <div class="event-description" id="eventDescription"></div>
            </div>
            <button class="event-ok-btn" onclick="closeEventPopup()" id="eventOkBtn">OK - Let's Go!</button>
            <div class="event-space-hint">Hit SPACE for OK</div>
        </div>
    </div>

    <div class="pause-overlay" id="pauseOverlay">
        <div class="pause-content">
            <h2>⏸️ Paused</h2>
            <button class="pause-resume-btn" onclick="resumeGame()" id="resumeBtn">▶️ Resume</button>
            <button class="pause-resume-btn" onclick="restartGame()" id="pauseRestartBtn">🔄 Restart</button>
        </div>
    </div>

    <div class="countdown" id="countdown">
        <div class="countdown-number" id="countdownNumber">3</div>
    </div>

    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <h2>Game Over!</h2>
            <div class="final-score">Final Score: <span id="finalScore">0</span></div>
            <div id="gameOverReason"></div>
            <button class="restart-btn" onclick="restartGame()" id="restartBtn">Play Again</button>
        </div>
    </div>

    <script>
        class RhythmGame {
            constructor() {
                this.symbols = ['star', 'triangle', 'square'];
                this.animalSymbols = ['cat', 'frog', 'dog', 'fox'];
                this.symbolMap = {
                    'star': '⬅️',
                    'triangle': '⬇️', 
                    'square': '➡️'
                };
                this.animalSymbolMap = {
                    'cat': '🐱',
                    'frog': '🐸',
                    'dog': '🐶',
                    'fox': '🦊'
                };
                this.keyMap = {
                    'arrowleft': 'star',
                    'arrowdown': 'triangle',
                    'arrowright': 'square'
                };
                this.animalKeyMap = {
                    'arrowleft': 'cat',
                    'arrowdown': 'frog',
                    'arrowright': 'dog',
                    'arrowup': 'fox'
                };
                
                this.queue = [];
                this.score = 0;
                this.inputsCount = 0;
                this.consecutiveWrong = 0;
                this.maxTime = 10000; // 10 seconds in ms
                this.currentTime = this.maxTime;
                this.timer = null;
                this.gameRunning = false;
                this.lastEventScore = 0;
                
                // Penalty system
                this.penaltyActive = false;
                this.penaltyCounter = 0;
                this.penaltyAwaitingResume = false;
                
                // Event system
                this.currentEvent = null;
                this.lastEvent = null;
                this.secondLastEvent = null;
                this.events = [
                    { 
                        id: 'h_clear_hj', 
                        name: 'Left Arrow Super Clear', 
                        description: '← key clears both ⬅️ and ⬇️ blocks (Left and middle). ↓ key is disabled!' 
                    },
                    { 
                        id: 'any_clear_all', 
                        name: 'Universal Clear', 
                        description: 'Any button clears any block!' 
                    },
                    { 
                        id: 'double_clear', 
                        name: 'Double Clear', 
                        description: 'Each correct input clears two blocks at once' 
                    },
                    { 
                        id: 'input_swap', 
                        name: 'Input Swap', 
                        description: 'Controls are swapped! ← clears ➡️ (right), → clears ⬅️ (left), ↓ still clears ⬇️' 
                    },
                    { 
                        id: 'animals', 
                        name: 'Animal Mode', 
                        description: '4-column mode with 🐱🐸🐶🦊 animals! Use ← ↓ → ↑ keys for 🐱🐸🐶🦊 correspondingly. 1.5x time bonus per hit!' 
                    },
                    { 
                        id: 'double_input', 
                        name: 'Double Input', 
                        description: 'Yellow-outlined blocks require two taps to clear!' 
                    },
                    { 
                        id: 'k_clear_jk', 
                        name: 'Right Arrow Super Clear', 
                        description: '→ key clears both ⬇️ and ➡️ blocks. ↓ key is disabled!' 
                    },
                    { 
                        id: 'score_depress', 
                        name: 'Score Depression', 
                        description: 'Base score reduced by 20%' 
                    },
                    { 
                        id: 'bonus_score', 
                        name: 'Score Boost', 
                        description: 'Base score increased by 20%' 
                    },
                    { 
                        id: 'basic_game', 
                        name: 'Basic Mode', 
                        description: 'All special effects removed - back to normal gameplay' 
                    }
                ];
                this.doubleInputRequired = {};
                
                // Pause system
                this.isPaused = false;
                
                this.initializeGame();
                this.bindEvents();
            }

            initializeGame() {
                this.queue = [];
                for (let i = 0; i < 10; i++) {
                    const symbol = this.getRandomSymbol();
                    const item = {
                        symbol: symbol,
                        id: Math.random()
                    };
                    
                    // Apply double input requirement during double input event
                    if (this.currentEvent === 'double_input' && Math.random() < 0.3) {
                        item.requiresDoubleInput = true;
                    }
                    
                    this.queue.push(item);
                }
                this.renderQueue();
            }

            getRandomSymbol() {
                if (this.currentEvent === 'animals') {
                    return this.animalSymbols[Math.floor(Math.random() * this.animalSymbols.length)];
                }
                return this.symbols[Math.floor(Math.random() * this.symbols.length)];
            }

            getCurrentSymbolMap() {
                if (this.currentEvent === 'animals') {
                    return this.animalSymbolMap;
                }
                return this.symbolMap;
            }

            renderQueue() {
                const queueContainer = document.getElementById('queueRows');
                const symbolMap = this.getCurrentSymbolMap();
                
                queueContainer.innerHTML = '';

                const headersDiv = document.createElement('div');
                headersDiv.className = 'column-headers';
                
                let columnOrder, headerLabels, headerClasses;
                
                if (this.currentEvent === 'animals') {
                    columnOrder = ['cat', 'frog', 'dog', 'fox'];
                    headerLabels = ['← - 🐱', '↓ - 🐸', '→ - 🐶', '↑ - 🦊'];
                    headerClasses = ['star', 'triangle', 'square', 'star'];
                    headersDiv.classList.add('four-columns');
                } else if (this.currentEvent === 'input_swap') {
                    columnOrder = ['star', 'triangle', 'square'];
                    headerLabels = ['→ - ⬅️', '↓ - ⬇️', '← - ➡️'];
                    headerClasses = ['star', 'triangle', 'square'];
                } else {
                    columnOrder = ['star', 'triangle', 'square'];
                    headerLabels = ['← - ⬅️', '↓ - ⬇️', '→ - ➡️'];
                    headerClasses = ['star', 'triangle', 'square'];
                }

                headerLabels.forEach((label, index) => {
                    const header = document.createElement('div');
                    header.className = `column-header ${headerClasses[index]}`;
                    if (this.currentEvent === 'animals') {
                        header.classList.add('four-columns');
                    }
                    header.textContent = label;
                    headersDiv.appendChild(header);
                });
                
                queueContainer.appendChild(headersDiv);
                
                const queueRowsContainer = document.createElement('div');
                queueRowsContainer.className = 'queue-rows';
                if (this.currentEvent === 'animals') {
                    queueRowsContainer.classList.add('four-columns');
                }
                
                for (let i = 0; i < 10; i++) {
                    const row = document.createElement('div');
                    row.className = 'queue-row';
                    
                    const numColumns = (this.currentEvent === 'animals') ? 4 : 3;
                    
                    for (let j = 0; j < numColumns; j++) {
                        const slot = document.createElement('div');
                        slot.className = 'queue-slot';
                        
                        const currentItem = this.queue[i];
                        const expectedSymbolForThisSlot = columnOrder[j];
                            
                        if (currentItem && currentItem.symbol === expectedSymbolForThisSlot) {
                            slot.classList.add('filled');
                            if (i === 0) slot.classList.add('current');
                            
                            const item = document.createElement('div');
                            let className = `queue-item ${currentItem.symbol}`;
                            
                            if (currentItem.requiresDoubleInput && !this.doubleInputRequired[currentItem.id]) {
                                item.style.border = '3px solid #FFFF00';
                                item.style.borderRadius = '8px';
                            }
                            
                            item.className = className;
                            item.textContent = symbolMap[currentItem.symbol];
                            item.setAttribute('data-id', currentItem.id);
                            slot.appendChild(item);
                        } else {
                            slot.classList.add('empty');
                        }
                        
                        row.appendChild(slot);
                    }
                    
                    queueRowsContainer.appendChild(row);
                }
                
                queueContainer.appendChild(queueRowsContainer);
            }

            startTimer() {
                this.currentTime = this.maxTime;
                this.updateTimerDisplay();
                
                this.timer = setInterval(() => {
                    this.currentTime -= 100;
                    this.updateTimerDisplay();
                    
                    if (this.currentTime <= 0) {
                        if (this.penaltyActive) {
                            this.endPenalty();
                        }
                        this.endGame('Time\'s up!');
                    }
                }, 100);
            }

            updateTimerDisplay() {
                const timerElement = document.getElementById('timer');
                const timerBarElement = document.getElementById('timerBar');
                const seconds = (this.currentTime / 1000).toFixed(1);
                timerElement.textContent = seconds + 's';
                
                const percentage = (this.currentTime / 10000) * 100;
                timerBarElement.style.width = Math.max(0, percentage) + '%';
                
                if (this.currentTime <= 3000) {
                    timerElement.classList.add('warning');
                    timerBarElement.classList.add('warning');
                } else {
                    timerElement.classList.remove('warning');
                    timerBarElement.classList.remove('warning');
                }
            }

            processInput(key) {
                if (this.isPaused) return;
                
                if (this.penaltyActive) {
                    if (this.penaltyAwaitingResume) {
                        if (key === ' ') {
                            this.endPenalty();
                        }
                        return;
                    }
                    
                    if (['arrowleft', 'arrowdown', 'arrowright'].includes(key)) {
                        this.penaltyCounter--;
                        document.getElementById('penaltyCounter').textContent = this.penaltyCounter;
                        
                        if (this.penaltyCounter <= 0) {
                            this.penaltyAwaitingResume = true;
                            document.getElementById('penaltyInstruction').textContent = 'Press SPACE to resume gameplay';
                            document.getElementById('penaltyInstruction').className = 'penalty-resume';
                        }
                    }
                    return;
                }
                
                if (!this.gameRunning) return;
                
                const currentItem = this.queue[0];
                if (!currentItem) return;
                
                this.showKeyPress(key);
                
                let isCorrect = false;
                let clearedItems = 0;
                
                if (this.currentEvent === 'animals') {
                    if ((currentItem.symbol === 'cat' && key === 'arrowleft') ||
                        (currentItem.symbol === 'frog' && key === 'arrowdown') ||
                        (currentItem.symbol === 'dog' && key === 'arrowright') ||
                        (currentItem.symbol === 'fox' && key === 'arrowup')) {
                        isCorrect = true;
                        clearedItems = 1;
                    }
                } else if (this.currentEvent === 'any_clear_all') {
                    isCorrect = true;
                    clearedItems = 1;
                } else if (this.currentEvent === 'h_clear_hj') {
                    if (key === 'arrowleft' && (currentItem.symbol === 'star' || currentItem.symbol === 'triangle')) {
                        isCorrect = true;
                        clearedItems = 1;
                    } else if (key === 'arrowright' && currentItem.symbol === 'square') {
                        isCorrect = true;
                        clearedItems = 1;
                    }
                } else if (this.currentEvent === 'k_clear_jk') {
                    if (key === 'arrowright' && (currentItem.symbol === 'triangle' || currentItem.symbol === 'square')) {
                        isCorrect = true;
                        clearedItems = 1;
                    } else if (key === 'arrowleft' && currentItem.symbol === 'star') {
                        isCorrect = true;
                        clearedItems = 1;
                    }
                } else if (this.currentEvent === 'double_clear') {
                    if ((currentItem.symbol === 'star' && key === 'arrowleft') ||
                        (currentItem.symbol === 'triangle' && key === 'arrowdown') ||
                        (currentItem.symbol === 'square' && key === 'arrowright')) {
                        isCorrect = true;
                        clearedItems = 2;
                    }
                } else if (this.currentEvent === 'double_input') {
                    if ((currentItem.symbol === 'star' && key === 'arrowleft') ||
                        (currentItem.symbol === 'triangle' && key === 'arrowdown') ||
                        (currentItem.symbol === 'square' && key === 'arrowright')) {
                        
                        if (currentItem.requiresDoubleInput) {
                            if (!this.doubleInputRequired[currentItem.id]) {
                                this.doubleInputRequired[currentItem.id] = 1;
                                this.currentTime = Math.min(10000, this.currentTime + 300);
                                this.renderQueue();
                                return;
                            } else {
                                isCorrect = true;
                                clearedItems = 1;
                                delete this.doubleInputRequired[currentItem.id];
                            }
                        } else {
                            isCorrect = true;
                            clearedItems = 1;
                        }
                    }
                } else if (this.currentEvent === 'input_swap') {
                    if ((currentItem.symbol === 'square' && key === 'arrowleft') ||
                        (currentItem.symbol === 'triangle' && key === 'arrowdown') ||
                        (currentItem.symbol === 'star' && key === 'arrowright')) {
                        isCorrect = true;
                        clearedItems = 1;
                    }
                } else {
                    if ((currentItem.symbol === 'star' && key === 'arrowleft') ||
                        (currentItem.symbol === 'triangle' && key === 'arrowdown') ||
                        (currentItem.symbol === 'square' && key === 'arrowright')) {
                        isCorrect = true;
                        clearedItems = 1;
                    }
                }
                
                if (isCorrect && clearedItems > 0) {
                    this.consecutiveWrong = 0;
                    this.inputsCount++;
                    
                    let timeBonus = 300;
                    if (this.currentEvent === 'animals') {
                        timeBonus = 450;
                    }
                    this.currentTime = Math.min(10000, this.currentTime + timeBonus);
                    
                    for (let i = 0; i < clearedItems && this.queue.length > 0; i++) {
                        this.queue.shift();
                        
                        const newItem = {
                            symbol: this.getRandomSymbol(),
                            id: Math.random()
                        };
                        
                        // Apply double input requirement for new blocks during double input event
                        if (this.currentEvent === 'double_input' && Math.random() < 0.3) {
                            newItem.requiresDoubleInput = true;
                        }
                        
                        this.queue.push(newItem);
                    }
                    
                    this.score += 10 * clearedItems;
                    
                    if (Math.floor(this.score / 600) > Math.floor(this.lastEventScore / 600)) {
                        this.triggerEvent();
                        return;
                    }
                    
                    this.renderQueue();
                    this.updateScore();
                } else {
                    this.startPenalty();
                    this.consecutiveWrong++;
                    if (this.consecutiveWrong >= 2) {
                        this.endGame('Two consecutive wrong inputs!');
                    }
                }
            }

            showKeyPress(key) {
                let keyElementId = '';
                if (key === 'arrowleft') keyElementId = 'keyArrowLeft';
                else if (key === 'arrowdown') keyElementId = 'keyArrowDown';
                else if (key === 'arrowright') keyElementId = 'keyArrowRight';
                
                const keyElement = document.getElementById(keyElementId);
                if (keyElement) {
                    keyElement.classList.add('pressed');
                    setTimeout(() => keyElement.classList.remove('pressed'), 150);
                }
            }

            startPenalty() {
                this.penaltyActive = true;
                this.penaltyAwaitingResume = false;
                this.penaltyCounter = Math.floor(Math.random() * 8) + 3;
                
                document.getElementById('penaltyCounter').textContent = this.penaltyCounter;
                document.getElementById('penaltyInstruction').textContent = 'Wrong input! Smash the poop to continue!\nHit ←, ↓ or → to beat the 💩 counter to 0';
                document.getElementById('penaltyInstruction').className = 'penalty-instruction';
                document.getElementById('penaltyOverlay').style.display = 'flex';
            }

            endPenalty() {
                this.penaltyActive = false;
                this.penaltyAwaitingResume = false;
                this.penaltyCounter = 0;
                document.getElementById('penaltyOverlay').style.display = 'none';
            }

            triggerEvent() {
                this.gameRunning = false;
                clearInterval(this.timer);
                this.lastEventScore = this.score;
                
                this.resetEventState();
                this.currentTime = Math.min(10000, this.currentTime + 2000);
                
                let availableEvents;
                
                if (this.currentEvent === null && this.lastEvent === null) {
                    availableEvents = this.events.filter(event => event.id !== 'basic_game');
                } else {
                    availableEvents = this.events.filter(event => 
                        event.id !== this.currentEvent && 
                        event.id !== this.lastEvent && 
                        event.id !== this.secondLastEvent
                    );
                    
                    if (availableEvents.length < 3) {
                        availableEvents = this.events.filter(event => 
                            event.id !== this.currentEvent && 
                            event.id !== this.lastEvent
                        );
                    }
                    
                    if (availableEvents.length === 0) {
                        availableEvents = this.events;
                    }
                }
                
                const randomEvent = availableEvents[Math.floor(Math.random() * availableEvents.length)];
                
                this.secondLastEvent = this.lastEvent;
                this.lastEvent = this.currentEvent;
                this.currentEvent = randomEvent.id;
                
                this.initializeGame();
                
                const eventDescriptionElement = document.getElementById('eventDescription');
                eventDescriptionElement.innerHTML = `
                    <div style="color: rgba(255, 215, 0, 0.9); font-weight: bold; font-size: 1.4em; margin-bottom: 8px;">
                        ${randomEvent.name}
                    </div>
                    <div style="color: rgba(255, 215, 0, 0.7); font-weight: normal; font-size: 1em; line-height: 1.4;">
                        ${randomEvent.description}
                    </div>
                `;
                document.getElementById('eventPopup').style.display = 'flex';
            }

            resetEventState() {
                this.doubleInputRequired = {};
                this.penaltyActive = false;
                this.penaltyCounter = 0;
                this.penaltyAwaitingResume = false;
            }

            updateScore() {
                document.getElementById('score').textContent = this.score;
                document.getElementById('inputsCount').textContent = this.inputsCount;
            }

            endGame(reason) {
                this.gameRunning = false;
                clearInterval(this.timer);
                
                // Hide penalty screen if it's active
                if (this.penaltyActive) {
                    this.endPenalty();
                }
                
                // Also ensure pause screen is hidden
                document.getElementById('pauseOverlay').style.display = 'none';
                
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('gameOverReason').textContent = reason;
                document.getElementById('gameOver').style.display = 'flex';
            }

            bindEvents() {
                document.addEventListener('keydown', (e) => {
                    const key = e.key.toLowerCase();
                    
                    if (key === ' ') {
                        e.preventDefault();
                        
                        if (this.penaltyAwaitingResume) {
                            this.processInput(' ');
                            return;
                        }
                        
                        if (document.getElementById('startScreen').style.display !== 'none') {
                            document.getElementById('startBtn').click();
                        } else if (document.getElementById('eventPopup').style.display === 'flex') {
                            document.getElementById('eventOkBtn').click();
                        } else if (document.getElementById('pauseOverlay').style.display === 'flex') {
                            document.getElementById('resumeBtn').click();
                        } else if (document.getElementById('gameOver').style.display === 'flex') {
                            document.getElementById('restartBtn').click();
                        }
                        return;
                    }
                    
                    if (['arrowleft', 'arrowdown', 'arrowright', 'arrowup'].includes(key)) {
                        e.preventDefault();
                        this.processInput(key);
                    }
                });
            }

            start() {
                this.showCountdown();
            }

            showCountdown() {
                const countdownElement = document.getElementById('countdown');
                const numberElement = document.getElementById('countdownNumber');
                let count = 3;
                
                countdownElement.style.display = 'flex';
                numberElement.textContent = count;
                numberElement.style.animation = 'countdownPulse 1s ease-in-out';
                
                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        numberElement.textContent = count;
                        numberElement.style.animation = 'none';
                        numberElement.offsetHeight;
                        numberElement.style.animation = 'countdownPulse 1s ease-in-out';
                    } else {
                        numberElement.textContent = 'GO!';
                        numberElement.style.animation = 'countdownPulse 1s ease-in-out';
                        
                        setTimeout(() => {
                            countdownElement.style.display = 'none';
                            this.gameRunning = true;
                            this.startTimer();
                        }, 1000);
                        
                        clearInterval(countdownInterval);
                    }
                }, 1000);
            }

            restart() {
                this.score = 0;
                this.inputsCount = 0;
                this.consecutiveWrong = 0;
                this.maxTime = 10000;
                this.currentTime = this.maxTime;
                this.lastEventScore = 0;
                this.currentEvent = null;
                this.lastEvent = null;
                this.secondLastEvent = null;
                this.penaltyActive = false;
                this.penaltyCounter = 0;
                this.penaltyAwaitingResume = false;
                this.doubleInputRequired = {};
                this.isPaused = false;
                this.queue = [];
                
                this.initializeGame();
                this.updateScore();
                this.start();
            }
        }

        let game;

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            game = new RhythmGame();
            game.start();
        }

        function restartGame() {
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('pauseOverlay').style.display = 'none';
            game.restart();
        }

        function closeEventPopup() {
            document.getElementById('eventPopup').style.display = 'none';
            game.showCountdown();
        }

        function pauseGame() {
            if (typeof game !== 'undefined' && game && game.gameRunning && !game.isPaused) {
                game.isPaused = true;
                clearInterval(game.timer);
                document.getElementById('pauseOverlay').style.display = 'flex';
            }
        }

        function resumeGame() {
            if (typeof game !== 'undefined' && game && game.isPaused) {
                game.isPaused = false;
                document.getElementById('pauseOverlay').style.display = 'none';
                game.startTimer();
            }
        }
    </script>
</body>
</html>